# ClawFactory Docker Compose
# Gateway (OpenClaw) + Controller (authority)
#
# Usage: ./clawfactory.sh -i <instance> start
#
# Instance name is set via INSTANCE_NAME env var
# Container names: clawfactory-{instance}-{service}
#
# Multi-instance support:
#   Set GATEWAY_PORT and CONTROLLER_PORT in secrets/<instance>/controller.env
#   Default ports: Gateway=18789, Controller=8080
#
# Architecture:
#   approved/     - Git clone (bot pushes branches, PRs merged on GitHub)
#   state/        - Runtime state (encrypted snapshots)

services:
  # ============================================================
  # Proxy: Nginx reverse proxy for local access
  # ============================================================
  proxy:
    image: nginx:alpine
    container_name: clawfactory-${INSTANCE_NAME:-default}-proxy
    restart: unless-stopped
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-logs:/var/log/nginx
    ports:
      - "127.0.0.1:${GATEWAY_PORT:-18789}:80"
      - "127.0.0.1:${CONTROLLER_PORT:-8080}:8080"
    networks:
      - clawfactory
    depends_on:
      - gateway
      - controller
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================================
  # ============================================================
  # Gateway: OpenClaw agent runtime
  # - Connects to Discord
  # - Makes LLM calls (routed through LLM proxy for logging)
  # - Uses OpenClaw's native sandbox for tool execution
  # - Bot pushes branches to approved/, PRs merged on GitHub
  # ============================================================
  gateway:
    build:
      context: ./bot_repos/${INSTANCE_NAME:-default}/approved
      dockerfile: Dockerfile
    image: clawfactory-gateway:${INSTANCE_NAME:-local}
    container_name: clawfactory-${INSTANCE_NAME:-default}-gateway
    restart: unless-stopped
    env_file:
      - ./secrets/${INSTANCE_NAME:-default}/gateway.env
    environment:
      - OPENCLAW_GATEWAY_MODE=local
      - OPENCLAW_GATEWAY_AUTH=none
      - INSTANCE_NAME=${INSTANCE_NAME:-default}
      # Route LLM API calls through logging proxy
      - ANTHROPIC_BASE_URL=http://llm-proxy:9090/anthropic
      - OPENAI_BASE_URL=http://llm-proxy:9090/openai
      - GEMINI_API_BASE=http://llm-proxy:9090/gemini
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Secure state directory permissions
        chmod 700 /home/node/.openclaw 2>/dev/null || true

        # Sync approved config files to OpenClaw workspace on startup
        echo "[startup] Syncing workspace from approved config..."
        cp -r /workspace/approved/workspace/*.md /home/node/.openclaw/workspace/ 2>/dev/null || true
        cp -r /workspace/approved/workspace/skills /home/node/.openclaw/workspace/ 2>/dev/null || true
        cp -r /workspace/approved/workspace/policies.yml /home/node/.openclaw/workspace/ 2>/dev/null || true

        # Memory stays in state/ (encrypted snapshots, not git)
        mkdir -p /home/node/.openclaw/workspace/memory

        # Migrate existing memory from approved if state is empty (one-time)
        if [ -d "/workspace/approved/workspace/memory" ] && [ -z "$(ls -A /home/node/.openclaw/workspace/memory 2>/dev/null)" ]; then
          echo "[startup] Migrating memory from approved to state..."
          cp -r /workspace/approved/workspace/memory/* /home/node/.openclaw/workspace/memory/ 2>/dev/null || true
        fi
        if [ -f "/workspace/approved/workspace/MEMORY.md" ] && [ ! -f "/home/node/.openclaw/workspace/MEMORY.md" ]; then
          cp /workspace/approved/workspace/MEMORY.md /home/node/.openclaw/workspace/MEMORY.md
        fi

        # Install packages from {instance}_save/package.json if changed
        SAVE_DIR="/workspace/approved/workspace/$${INSTANCE_NAME}_save"
        INSTALL_DIR="/home/node/.openclaw/installed"
        if [ -f "$$SAVE_DIR/package.json" ]; then
          mkdir -p "$$INSTALL_DIR"
          CURRENT_HASH=$$(sha256sum "$$SAVE_DIR/package.json" | cut -d' ' -f1)
          LAST_HASH=""
          if [ -f "$$INSTALL_DIR/.package-hash" ]; then
            LAST_HASH=$$(cat "$$INSTALL_DIR/.package-hash")
          fi
          if [ "$$CURRENT_HASH" != "$$LAST_HASH" ]; then
            echo "[startup] Installing packages from $${INSTANCE_NAME}_save/package.json..."
            cp "$$SAVE_DIR/package.json" "$$INSTALL_DIR/"
            [ -f "$$SAVE_DIR/package-lock.json" ] && cp "$$SAVE_DIR/package-lock.json" "$$INSTALL_DIR/"
            cd "$$INSTALL_DIR" && npm install --production
            echo "$$CURRENT_HASH" > "$$INSTALL_DIR/.package-hash"
            echo "[startup] Packages installed"
          else
            echo "[startup] Packages unchanged, skipping install"
          fi
        fi

        echo "[startup] Workspace synced"

        # Run minimal setup then start gateway
        node dist/index.js onboard --non-interactive --accept-risk --mode local \
          --skip-daemon --skip-channels --skip-skills --skip-health --skip-ui \
          --gateway-auth token --gateway-token "$$OPENCLAW_GATEWAY_TOKEN" && \
        node dist/index.js gateway --port 18789 --bind lan
    user: "1000:1000"  # Run as node user
    volumes:
      # OpenClaw home directory (config, state, embeddings, installed packages)
      - ./bot_repos/${INSTANCE_NAME:-default}/state:/home/node/.openclaw
      # Git repo clone (bot pushes branches, PRs merged on GitHub)
      - ./bot_repos/${INSTANCE_NAME:-default}/approved:/workspace/approved:rw
      # Temp filesystem
      - type: tmpfs
        target: /tmp
    # No ports exposed - access via proxy
    networks:
      - clawfactory
    depends_on:
      - llm-proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================
  # LLM Proxy: Logging reverse proxy for AI provider APIs
  # - Intercepts outbound LLM calls (Anthropic, OpenAI, Gemini)
  # - Logs request/response to /srv/audit/traffic.jsonl
  # - Extracts token usage, applies scrub rules
  # ============================================================
  llm-proxy:
    build:
      context: ./controller
      dockerfile: Dockerfile
    container_name: clawfactory-${INSTANCE_NAME:-default}-llm-proxy
    restart: unless-stopped
    command: ["python3", "-m", "uvicorn", "llm_proxy:create_app", "--factory", "--host", "0.0.0.0", "--port", "9090"]
    environment:
      - TRAFFIC_LOG=/srv/audit/traffic.jsonl
      - SCRUB_RULES_PATH=/srv/audit/scrub_rules.json
      - CAPTURE_STATE_FILE=/srv/audit/capture_enabled
    volumes:
      - ./audit:/srv/audit:rw
    networks:
      - clawfactory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================================
  # Controller: Authority & promotion
  # - Receives GitHub webhooks
  # - Performs promotions (pulls main after PR merge)
  # - Restarts Gateway
  # - Manages encrypted snapshots
  # - Hosts approval UI (for offline mode)
  # ============================================================
  controller:
    build:
      context: ./controller
      dockerfile: Dockerfile
    container_name: clawfactory-${INSTANCE_NAME:-default}-controller
    restart: unless-stopped
    env_file:
      - ./secrets/${INSTANCE_NAME:-default}/controller.env
    environment:
      - APPROVED_DIR=/srv/bot/approved
      - OPENCLAW_HOME=/srv/bot/state
      - AUDIT_LOG=/srv/audit/audit.jsonl
      - GITHUB_REPO=${GITHUB_ORG:-${GITHUB_USERNAME}}/${INSTANCE_NAME:-default}-bot
      - INSTANCE_NAME=${INSTANCE_NAME:-default}
      - GATEWAY_CONTAINER=clawfactory-${INSTANCE_NAME:-default}-gateway
      - SNAPSHOTS_DIR=/srv/snapshots
      - AGE_KEY=/srv/secrets/snapshot.key
      - TRAFFIC_LOG=/srv/audit/traffic.jsonl
      - SCRUB_RULES_PATH=/srv/audit/scrub_rules.json
      - CAPTURE_STATE_FILE=/srv/audit/capture_enabled
      - NGINX_LOG=/var/log/nginx/access.json
    volumes:
      # Git repo clone: Controller pulls main after PR merge
      - ./bot_repos/${INSTANCE_NAME:-default}/approved:/srv/bot/approved:rw
      # OpenClaw state: For snapshots
      - ./bot_repos/${INSTANCE_NAME:-default}/state:/srv/bot/state:rw
      # Snapshots directory
      - ./snapshots/${INSTANCE_NAME:-default}:/srv/snapshots:rw
      # Secrets (for snapshot encryption key)
      - ./secrets/${INSTANCE_NAME:-default}:/srv/secrets:ro
      # Audit log
      - ./audit:/srv/audit:rw
      # Docker socket for restarting gateway
      # Linux: /var/run/docker.sock, Windows: //var/run/docker.sock (Docker Desktop handles this)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Nginx logs (read-only, for inbound traffic viewer)
      - nginx-logs:/var/log/nginx:ro
    # No ports exposed - access via proxy
    networks:
      - clawfactory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  clawfactory:
    driver: bridge

volumes:
  nginx-logs:
