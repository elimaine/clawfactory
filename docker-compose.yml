# ClawFactory Docker Compose
# Gateway (OpenClaw) + Controller (authority)
#
# Usage: ./clawfactory.sh start
# See todo/cloudflare/ for remote access setup
#
# Instance name is read from .env file (INSTANCE_NAME)
# Container names: clawfactory-{instance}-{service}

services:
  # ============================================================
  # Proxy: Nginx reverse proxy for local access
  # - Binds to localhost for secure local access
  # - Routes to gateway and controller inside Docker network
  # ============================================================
  proxy:
    image: nginx:alpine
    container_name: clawfactory-${INSTANCE_NAME:-default}-proxy
    restart: unless-stopped
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      # Local access only (localhost)
      - "127.0.0.1:18789:80"      # Gateway UI
      - "127.0.0.1:8080:8080"     # Controller
    networks:
      - clawfactory
    depends_on:
      - gateway
      - controller
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ============================================================
  # Gateway: OpenClaw agent runtime
  # - Connects to Discord
  # - Makes LLM calls
  # - Uses OpenClaw's native sandbox for tool execution
  # - READ-ONLY access to brain_ro, WRITE to brain_work
  # ============================================================
  gateway:
    build:
      context: ./data/brain_ro
      dockerfile: Dockerfile
    image: clawfactory-gateway:${INSTANCE_NAME:-local}
    container_name: clawfactory-${INSTANCE_NAME:-default}-gateway
    restart: unless-stopped
    env_file:
      - ./secrets/${INSTANCE_NAME:-default}/gateway.env
    environment:
      - OPENCLAW_GATEWAY_MODE=local
      - OPENCLAW_GATEWAY_AUTH=none
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        # Secure state directory permissions
        chmod 700 /home/node/.openclaw 2>/dev/null || true
        # Sync approved brain files from brain_ro/workspace to OpenClaw workspace on startup
        echo "[startup] Syncing workspace from approved brain_ro..."
        cp -r /workspace/brain_ro/workspace/*.md /home/node/.openclaw/workspace/ 2>/dev/null || true
        cp -r /workspace/brain_ro/workspace/skills /home/node/.openclaw/workspace/ 2>/dev/null || true
        cp -r /workspace/brain_ro/workspace/policies.yml /home/node/.openclaw/workspace/ 2>/dev/null || true
        # Memory persists directly via volume mount to brain_work/workspace/memory
        # No copy needed - memory survives restarts and can be committed to git
        mkdir -p /home/node/.openclaw/workspace/memory
        # Only copy MEMORY.md if it exists in brain_ro and not locally
        if [ -f "/workspace/brain_ro/workspace/MEMORY.md" ] && [ ! -f "/home/node/.openclaw/workspace/MEMORY.md" ]; then
          cp /workspace/brain_ro/workspace/MEMORY.md /home/node/.openclaw/workspace/ 2>/dev/null || true
        fi
        echo "[startup] Workspace synced"
        # Run minimal setup then start gateway
        node dist/index.js onboard --non-interactive --accept-risk --mode local \
          --skip-daemon --skip-channels --skip-skills --skip-health --skip-ui \
          --gateway-auth token --gateway-token "$$OPENCLAW_GATEWAY_TOKEN" && \
        node dist/index.js gateway --port 18789 --bind lan
    user: "1000:1000"  # Run as node user
    volumes:
      # OpenClaw home directory (config, state, workspace)
      - ./data/openclaw-home:/home/node/.openclaw
      # Approved brain (OpenClaw fork, read-only)
      - ./data/brain_ro:/workspace/brain_ro:ro
      # Proposal workspace (OpenClaw fork clone, agent pushes branches here)
      - ./data/brain_work:/workspace/proposals:rw
      # Memory persists directly in brain_work (survives restarts, can be committed)
      - ./data/brain_work/workspace/memory:/home/node/.openclaw/workspace/memory:rw
      # Temp filesystem
      - type: tmpfs
        target: /tmp
    # No ports exposed - access via proxy
    networks:
      - clawfactory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================
  # Controller: Authority & promotion
  # - Receives GitHub webhooks
  # - Performs promotions (brain_work â†’ brain_ro)
  # - Restarts Gateway
  # - Hosts approval UI (for offline mode)
  # ============================================================
  controller:
    build:
      context: ./controller
      dockerfile: Dockerfile
    container_name: clawfactory-${INSTANCE_NAME:-default}-controller
    restart: unless-stopped
    env_file:
      - ./secrets/${INSTANCE_NAME:-default}/controller.env
    environment:
      - BRAIN_RO=/srv/data/brain_ro
      - BRAIN_WORK=/srv/data/brain_work
      - OPENCLAW_HOME=/srv/openclaw-home
      - AUDIT_LOG=/srv/audit/audit.jsonl
      - GITHUB_REPO=${GITHUB_USERNAME:-}/${INSTANCE_NAME:-default}-brain
      - INSTANCE_NAME=${INSTANCE_NAME:-default}
      - GATEWAY_CONTAINER=clawfactory-${INSTANCE_NAME:-default}-gateway
    volumes:
      # Brain directories: Controller pulls from GitHub to brain_ro
      - ./data/brain_ro:/srv/data/brain_ro:rw
      # brain_work: Controller can commit memory backups
      - ./data/brain_work:/srv/data/brain_work:rw
      # OpenClaw home: Read memory files for backup
      - ./data/openclaw-home:/srv/openclaw-home:ro
      # Audit log
      - ./audit:/srv/audit:rw
      # Docker socket for restarting gateway
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # No ports exposed - access via proxy
    networks:
      - clawfactory
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  clawfactory:
    driver: bridge

volumes: {}
